# Research Notes Skill 评审总结

## 评审日期
2026-02-12

## 总体评价

这个 Research Notes skill 是一个**设计良好**的层级化研究和想法管理系统，用于学术论文、工程项目和研究工作流程。整体架构清晰，文档完善，但存在一些需要改进的问题。

**总体评分：7.5/10**

## 主要优点 ✅

### 1. 文档质量优秀 (9/10)
- README.md 清晰完整，有很好的示例
- SKILL.md 详尽（580行），覆盖所有功能
- workflows.md 提供实用的工作流程指南
- 文档格式统一，代码示例丰富

### 2. 架构设计合理 (8/10)
- 清晰的层级结构：项目 → 想法 → 实验
- 基于 Markdown，便于人类阅读和版本控制
- 使用 YAML 元数据，保持一致性
- 完善的验证状态定义（未验证 → 计划中 → 进行中 → 已验证/已拒绝）
- 提供模板系统，快速创建

### 3. 功能丰富 (8/10)
- 项目管理（学术/工程/方向三种类型）
- 想法跟踪（含优先级）
- 实验管理（含实验数据）
- 全文搜索功能
- Notion 集成（基础版）
- Git 友好设计

### 4. 代码风格一致 (7/10)
- 所有脚本遵循相似模式
- 良好使用辅助函数（slugify）
- 合理的错误处理
- 一致使用 UTF-8 编码

## 主要问题 ❌

### 1. 关键问题（必须修复）

#### 1.1 硬编码路径假设 (严重)
**严重程度：高**

所有脚本都使用这种有问题的路径计算：
```python
workspace = Path(__file__).parent.parent.parent.parent.parent
research_root = workspace / "research-notes"
```

**问题：**
- 假设脚本始终在 5 层深的目录结构中
- 如果脚本位置改变会失败
- 跨不同安装环境不可移植
- 假设特定位置存在 `research-notes` 目录

**影响：**脚本会在以下情况失败：
- 克隆到不同的目录名
- 从不同位置运行脚本
- 作为库或已安装包使用

#### 1.2 错误信息质量差 (高)
**示例：**
- `"错误：未找到项目 'X'"` - 不列出可用项目
- 解析失败时没有说明出了什么问题
- 搜索功能中的静默失败（`except: return []`）

#### 1.3 文件搜索效率低 (中)
**问题：**
- 线性搜索所有目录
- 多次重复读取项目标题
- 没有缓存或索引

**影响：**
- 项目多时（>50个）速度慢
- 冗余的 I/O 操作

### 2. 代码质量问题

#### 2.1 重复代码 (中等优先级)
**问题：**项目/想法查找代码在以下文件中重复：
- `create_idea.py`
- `create_experiment.py`  
- `update_validation.py`

**重复代码量：**每个文件约 40 行

#### 2.2 前置元数据解析不一致 (中)
**问题：**手动逐行解析而不是使用 YAML 解析器

当前方法：
```python
for line in content.split('\n'):
    if line.startswith("title:"):
        project_title = line.split(':', 1)[1].strip().strip('"\'')
```

**问题：**
- 脆弱（多行值会失败）
- 与 YAML 规范不一致
- 已导入 `yaml` 模块但未使用

#### 2.3 缺少输入验证 (中)
**缺失的验证：**
- 标题长度限制
- slugify 中的特殊字符处理
- 标签格式验证
- 日期格式验证

**潜在问题：**
- 很长的标题导致文件系统问题
- 特殊字符破坏文件路径
- 无效日期导致解析错误

#### 2.4 功能不完整 (中)
**已记录但未实现：**
1. 数据库备份（配置存在，无实现）
2. Git 集成脚本（找不到 `init_git.py`、`commit_changes.py`）
3. SKILL.md 中的大多数高级功能：
   - `query_db.py`
   - `export_validation.py`
   - `templates.py`
   - `backup.py`
   - 高级搜索功能

**影响：**用户期望的功能实际不工作

### 3. 安全问题

#### 3.1 路径遍历风险 (低-中)
**问题：**用户输入直接用于文件路径

当前的 `slugify()`：
```python
def slugify(text):
    return text.lower().replace(' ', '-').replace('_', '-')
```

**缺少的安全检查：**
- 不处理 `..`
- 不处理 `/` 或 `\`
- 不处理绝对路径

**测试结果：**
```python
slugify('../../../etc/passwd')  # 返回: '../../../etc/passwd'  ❌
slugify('test/subdir')          # 返回: 'test/subdir'          ❌
```

#### 3.2 标签解析错误 (已确认)
创建项目时标签格式不正确：
```bash
python3 scripts/create_project.py "Test" --tags "a,b"
# 显示: Tags: a", "b  ❌
```

## 测试结果确认

所有识别的问题都已通过实际测试确认：

| 问题 | 严重程度 | 已确认 | 修复优先级 |
|------|---------|--------|-----------|
| slugify 中的路径遍历 | 高 | ✓ | P1 |
| 硬编码路径 | 高 | ✓ | P1 |
| 标签解析错误 | 中 | ✓ | P1 |
| 静默失败 | 中 | ✓ | P2 |
| 缺少长度验证 | 中 | ✓ | P2 |
| 多个空格 | 低 | ✓ | P3 |

## 详细建议

### 优先级 1：修复关键路径问题
1. 移除硬编码路径假设
2. 使用环境变量或配置文件
3. 添加路径发现逻辑
4. 更新所有 8 个脚本

### 优先级 2：代码质量改进
1. 提取公共函数到 `utils.py`
2. 对前置元数据使用正确的 YAML 解析
3. 添加输入验证
4. 改进错误信息

### 优先级 3：实现缺失功能或更新文档
要么：
- 实现已记录的功能，或
- 移除未实现功能的文档
- 将功能标记为"计划中"（如果尚未实现）

### 优先级 4：添加测试
1. 创建 `tests/` 目录
2. 为核心函数添加单元测试
3. 为工作流程添加集成测试
4. 使用 GitHub Actions 添加 CI

### 优先级 5：增强安全性
1. 改进 `slugify()` 函数
2. 添加路径验证
3. 限制输入长度
4. 清理所有用户输入

## 改进参考

项目包含：
1. **SKILL_REVIEW.md** - 详细的英文评审（包含代码示例和详细建议）
2. **ISSUES_FOUND.md** - 经测试确认的问题文档
3. **scripts/utils_improved.py** - 改进的工具函数参考实现

### 改进的 slugify 函数示例

```python
def slugify(text: str, max_length: int = 100) -> str:
    """将文本转换为文件系统安全的 slug"""
    if not text:
        return 'untitled'
    
    text = text.lower()
    text = re.sub(r'[^\w\s-]', '', text)  # 移除特殊字符
    text = re.sub(r'[-\s]+', '-', text)    # 多个空格/破折号合并
    text = text.strip('-')
    
    # 防止路径遍历
    text = text.replace('..', '')
    text = text.replace('/', '')
    text = text.replace('\\', '')
    
    if len(text) > max_length:
        text = text[:max_length]
    
    return text if text else 'untitled'
```

### 测试结果对比

**改进前：**
```
Input:  '../../../etc/passwd'
Output: '../../../etc/passwd'  ❌ 危险！

Input:  'Project with    many   spaces'  
Output: 'project-with----many---spaces'  ⚠️ 次优
```

**改进后：**
```
Input:  '../../../etc/passwd'
Output: 'etcpasswd'  ✓ 安全

Input:  'Project with    many   spaces'
Output: 'project-with-many-spaces'  ✓ 正确
```

## 建议的行动计划

**第 1 阶段（1-2 天）：**
- 修复路径假设
- 提取公共工具函数
- 改进错误信息

**第 2 阶段（2-3 天）：**
- 添加输入验证
- 改进安全性
- 添加基本测试

**第 3 阶段（3-5 天）：**
- 实现缺失功能或清理文档
- 添加全面测试
- 性能优化

**总估计工作量：**全面改进需要 1-2 周

## 最终评分细分

- 文档：9/10
- 架构：8/10  
- 代码质量：6/10
- 功能：7/10
- 安全性：6/10
- 测试：2/10
- **总体：7.5/10**

通过推荐的改进，这个 skill 可以轻松达到 **9/10**，适合在研究环境中生产使用。

## 结论

Research Notes skill 有**坚实的基础**，具有：
- 清晰、合理的结构
- 优秀的文档
- 良好的功能设计
- 实用的工作流程

主要需要解决的问题：
1. **可移植性**：修复硬编码路径（关键）
2. **代码质量**：减少重复，改进解析
3. **完整性**：实现或记录缺失功能
4. **健壮性**：添加测试和验证
5. **安全性**：改进输入清理

这是一个很好的起点，经过建议的改进后，将成为一个优秀的研究管理工具！
